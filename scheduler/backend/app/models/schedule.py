"""
Schedule and StaffAssignment database models.
"""

from sqlalchemy import Column, String, Integer, Float, Boolean, DateTime, ForeignKey, Enum as SQLEnum, Text
from sqlalchemy.dialects.postgresql import UUID
from sqlalchemy.orm import relationship
from sqlalchemy.sql import func
import uuid
import enum

from app.database import Base


class SolverStatus(str, enum.Enum):
    """Constraint solver status."""

    OPTIMAL = "optimal"  # Optimal solution found
    FEASIBLE = "feasible"  # Feasible solution found (may not be optimal)
    INFEASIBLE = "infeasible"  # No solution exists
    TIMEOUT = "timeout"  # Solver timed out
    ERROR = "error"  # Solver encountered an error


class Schedule(Base):
    """
    Represents a weekly schedule.

    Generated by the constraint solver (OR-Tools).
    """

    __tablename__ = "schedules"

    # Primary key
    id = Column(UUID(as_uuid=True), primary_key=True, default=uuid.uuid4)

    # Week identification
    week_number = Column(Integer, nullable=False, index=True)  # 1-53
    year = Column(Integer, nullable=False, index=True)  # 2026, etc.

    # Solver results
    solver_status = Column(SQLEnum(SolverStatus), nullable=False)
    objective_value = Column(Float, nullable=True)  # Objective function value
    solve_time_ms = Column(Integer, nullable=True)  # Solving time in milliseconds

    # Constraint satisfaction
    hard_constraints_met = Column(Boolean, nullable=False, default=False)
    soft_constraints_score = Column(Float, nullable=True)  # 0-100

    # Publication
    is_published = Column(Boolean, default=False, nullable=False, index=True)

    # Metadata
    created_at = Column(DateTime(timezone=True), server_default=func.now(), nullable=False)
    created_by = Column(String(100), nullable=True)  # User or "system"

    # Relationships
    assignments = relationship(
        "StaffAssignment", back_populates="schedule", cascade="all, delete-orphan"
    )

    def __repr__(self):
        return f"<Schedule(id={self.id}, week={self.week_number}/{self.year}, status={self.solver_status.value})>"


class AssignmentType(str, enum.Enum):
    """Type of staff assignment."""

    ONE_TO_ONE = "one_to_one"  # 1:1 student coverage
    CLASS_COVERAGE = "class_coverage"  # General class support
    LEISURE = "leisure"  # Fritids coverage
    DOUBLE_STAFFING = "double_staffing"  # Double staffing for specific student


class StaffAssignment(Base):
    """
    Represents an assignment of a staff member to a student or class.

    This is the core scheduling unit - who works with whom, when.
    """

    __tablename__ = "staff_assignments"

    # Primary key
    id = Column(UUID(as_uuid=True), primary_key=True, default=uuid.uuid4)

    # Foreign keys
    schedule_id = Column(
        UUID(as_uuid=True),
        ForeignKey("schedules.id", ondelete="CASCADE"),
        nullable=False,
        index=True,
    )
    staff_id = Column(UUID(as_uuid=True), ForeignKey("staff.id"), nullable=False, index=True)
    student_id = Column(
        UUID(as_uuid=True), ForeignKey("students.id"), nullable=True, index=True
    )  # None for general coverage
    class_id = Column(
        UUID(as_uuid=True), ForeignKey("classes.id"), nullable=True, index=True
    )

    # Time allocation
    weekday = Column(Integer, nullable=False)  # 0=Monday, 6=Sunday
    start_time = Column(String(5), nullable=False)  # HH:MM
    end_time = Column(String(5), nullable=False)  # HH:MM

    # Assignment details
    assignment_type = Column(SQLEnum(AssignmentType), nullable=False)

    # Manual override flag
    is_manual_override = Column(Boolean, default=False, nullable=False)

    # Notes
    notes = Column(Text, nullable=True)

    # Timestamps
    created_at = Column(DateTime(timezone=True), server_default=func.now(), nullable=False)

    # Relationships
    schedule = relationship("Schedule", back_populates="assignments")
    staff = relationship("Staff", back_populates="assignments")
    student = relationship("Student", back_populates="assignments")
    school_class = relationship("SchoolClass")

    def __repr__(self):
        weekday_name = [
            "Mon",
            "Tue",
            "Wed",
            "Thu",
            "Fri",
            "Sat",
            "Sun",
        ][self.weekday]
        return f"<StaffAssignment(staff_id={self.staff_id}, student_id={self.student_id}, {weekday_name} {self.start_time}-{self.end_time})>"
