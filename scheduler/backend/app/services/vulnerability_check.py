"""
Vulnerability check — detect single points of failure in staffing.

For each student with care_requirements, find all staff with matching
care_certifications. If only 1 person can handle a requirement, that's CRITICAL.
If only 2, it's a WARNING.
"""

from uuid import UUID
from sqlalchemy.orm import Session

from app.models import Student, Staff


def check_vulnerabilities(db: Session) -> dict:
    """Check for single-point-of-failure vulnerabilities across all students."""
    students_with_care = (
        db.query(Student)
        .filter(Student.active == True, Student.has_care_needs == True)  # noqa: E712
        .all()
    )

    active_staff = (
        db.query(Staff)
        .filter(Staff.active == True)  # noqa: E712
        .all()
    )

    # Build cert-to-staff map
    cert_staff_map: dict[str, list[Staff]] = {}
    for staff in active_staff:
        for cert in (staff.care_certifications or []):
            cert_staff_map.setdefault(cert, []).append(staff)

    vulnerabilities = []

    for student in students_with_care:
        care_reqs = student.care_requirements or []
        if not care_reqs:
            continue

        for req in care_reqs:
            qualified = cert_staff_map.get(req, [])

            if len(qualified) <= 2:
                severity = "critical" if len(qualified) <= 1 else "warning"

                if len(qualified) == 0:
                    message = (
                        f"Ingen personal har certifiering för '{req}'. "
                        f"{student.full_name} saknar helt täckning."
                    )
                elif len(qualified) == 1:
                    message = (
                        f"Bara {qualified[0].full_name} kan hantera '{req}'. "
                        f"Om hen är borta finns ingen ersättare för {student.full_name}."
                    )
                else:
                    names = " och ".join(s.full_name for s in qualified)
                    message = (
                        f"Bara {names} kan hantera '{req}' för {student.full_name}. "
                        f"Begränsad flexibilitet vid frånvaro."
                    )

                vulnerabilities.append({
                    "student_id": str(student.id),
                    "student_name": student.full_name,
                    "care_requirement": req,
                    "qualified_staff": [
                        {"staff_id": str(s.id), "staff_name": s.full_name}
                        for s in qualified
                    ],
                    "severity": severity,
                    "message": message,
                })

    # Sort: critical first
    vulnerabilities.sort(key=lambda x: 0 if x["severity"] == "critical" else 1)

    return {
        "vulnerabilities": vulnerabilities,
        "critical_count": sum(1 for v in vulnerabilities if v["severity"] == "critical"),
        "warning_count": sum(1 for v in vulnerabilities if v["severity"] == "warning"),
    }
