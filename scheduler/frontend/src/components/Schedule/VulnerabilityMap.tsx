/**
 * VulnerabilityMap — student × weekday risk matrix.
 *
 * Shows a grid where rows are students with care needs and columns are weekdays.
 * Each cell is colored by risk level: green (covered), yellow (SPOF),
 * red (no qualified assigned), black (no one in staff pool).
 */

import { useState } from 'react';
import { Shield, ChevronDown, ChevronUp } from 'lucide-react';
import type { VulnerabilityMapResponse, VulnerabilityRisk } from '../../types/weekSchedule';

const DAY_NAMES = ['Mån', 'Tis', 'Ons', 'Tor', 'Fre'];

const RISK_COLORS: Record<VulnerabilityRisk, { bg: string; text: string; label: string }> = {
  green: { bg: 'bg-emerald-100', text: 'text-emerald-800', label: 'Täckt' },
  yellow: { bg: 'bg-amber-100', text: 'text-amber-800', label: 'Sårbart' },
  red: { bg: 'bg-red-100', text: 'text-red-800', label: 'Otäckt' },
  black: { bg: 'bg-surface-800', text: 'text-white', label: 'Omöjligt' },
  none: { bg: 'bg-surface-50', text: 'text-surface-400', label: '-' },
};

interface VulnerabilityMapProps {
  data: VulnerabilityMapResponse;
}

export function VulnerabilityMap({ data }: VulnerabilityMapProps) {
  const [expanded, setExpanded] = useState(false);

  if (data.students.length === 0) return null;

  const { summary } = data;
  const totalIssues = summary.black + summary.red + summary.yellow;

  return (
    <div className="card overflow-hidden">
      {/* Header */}
      <button
        onClick={() => setExpanded(!expanded)}
        className="w-full px-4 py-3 bg-surface-50 border-b border-surface-100 flex items-center justify-between hover:bg-surface-100 transition-colors"
      >
        <div className="flex items-center gap-3">
          <Shield className="h-4.5 w-4.5 text-indigo-500" />
          <h3 className="section-heading">Sårbarhetskarta</h3>
          <div className="flex items-center gap-2 ml-2">
            {summary.black > 0 && (
              <span className="text-[10px] font-bold px-1.5 py-0.5 rounded bg-surface-800 text-white">
                {summary.black} omöjliga
              </span>
            )}
            {summary.red > 0 && (
              <span className="text-[10px] font-bold px-1.5 py-0.5 rounded bg-red-100 text-red-700">
                {summary.red} otäckta
              </span>
            )}
            {summary.yellow > 0 && (
              <span className="text-[10px] font-bold px-1.5 py-0.5 rounded bg-amber-100 text-amber-700">
                {summary.yellow} sårbara
              </span>
            )}
            {totalIssues === 0 && (
              <span className="text-[10px] font-bold px-1.5 py-0.5 rounded bg-emerald-100 text-emerald-700">
                Alla täckta
              </span>
            )}
          </div>
        </div>
        {expanded ? (
          <ChevronUp className="h-4 w-4 text-surface-400" />
        ) : (
          <ChevronDown className="h-4 w-4 text-surface-400" />
        )}
      </button>

      {/* Matrix */}
      {expanded && (
        <div className="overflow-x-auto">
          <table className="min-w-full">
            <thead>
              <tr className="bg-surface-50/50">
                <th className="px-3 py-2 text-left text-xs font-medium text-surface-500 uppercase w-48">
                  Elev
                </th>
                <th className="px-3 py-2 text-left text-xs font-medium text-surface-500 uppercase w-28">
                  Behov
                </th>
                {DAY_NAMES.map((name, i) => (
                  <th
                    key={i}
                    className="px-2 py-2 text-center text-xs font-medium text-surface-500 uppercase w-24"
                  >
                    {name}
                  </th>
                ))}
              </tr>
            </thead>
            <tbody className="divide-y divide-surface-100">
              {data.students.map((student) => (
                <tr key={student.student_id} className="hover:bg-surface-50/50 transition-colors">
                  <td className="px-3 py-2">
                    <div className="text-sm font-medium text-surface-800">{student.student_name}</div>
                    <div className="text-xs text-surface-400">
                      {student.class_name || `Årskurs ${student.grade}`}
                    </div>
                  </td>
                  <td className="px-3 py-2">
                    <div className="flex flex-wrap gap-1">
                      {student.care_requirements.map((req) => (
                        <span
                          key={req}
                          className="text-[10px] px-1.5 py-0.5 rounded bg-indigo-100 text-indigo-700 font-medium"
                        >
                          {req}
                        </span>
                      ))}
                    </div>
                  </td>
                  {student.days.map((day) => {
                    const style = RISK_COLORS[day.risk];
                    return (
                      <td key={day.weekday} className="px-2 py-2 text-center">
                        <div
                          className={`inline-flex items-center justify-center w-16 h-8 rounded-lg text-[10px] font-bold ${style.bg} ${style.text} cursor-default`}
                          title={day.detail}
                        >
                          {style.label}
                        </div>
                      </td>
                    );
                  })}
                </tr>
              ))}
            </tbody>
          </table>

          {/* Legend */}
          <div className="px-4 py-3 border-t border-surface-100 flex items-center gap-4 text-xs text-surface-500">
            <span className="font-medium">Förklaring:</span>
            {(['green', 'yellow', 'red', 'black'] as const).map((risk) => {
              const style = RISK_COLORS[risk];
              return (
                <span key={risk} className="inline-flex items-center gap-1.5">
                  <span className={`w-3 h-3 rounded ${style.bg} border border-surface-200`} />
                  {style.label}
                </span>
              );
            })}
          </div>
        </div>
      )}
    </div>
  );
}
